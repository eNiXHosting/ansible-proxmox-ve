---


# Create device vg
- name: "Create LVM vg"
  lvg:
    vg: "{{ item.name }}"
    pvs: "{{ item.devices | join (',') }}"
    pesize: "{{ item.pesize }}"
    state: present
  with_items:
    - "{{ proxmox_ve__storage_lvm }}"

# Disable autoactivation of volumes
- name: "Disable LVM auto volume activation"
  lineinfile:
    path: /etc/lvm/lvm.conf
    regexp: "^auto_activation_volume_list ="
    line: "auto_activation_volume_list = []"
    insertafter: "^\t# auto_activation_volume_list = "
    state: present
    backup: yes


# Add to proxmox configuration
# FIXME switch to regexp match
- name: "Update proxmox configuration"
  blockinfile:
    path: /etc/pve/storage.cfg
    backup: yes
    marker: "# {mark} ANSIBLE MANAGED BLOCK lvm:{{ item.name }}"
    state: present
    block : |
      lvm: {{ item.name }}
        vgname {{ item.name }}
        content images
        shared {{ item.shared }}
        
  with_items:
    - "{{ proxmox_ve__storage_lvm }}"
